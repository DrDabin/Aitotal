//---------------------------------------------------------------------------
#include <vcl.h>
#include <System.IOUtils.hpp>
#include <StrUtils.hpp>

#pragma hdrstop
 #include "Aitotal1.h"
#include "RabotaSfilam.h"

//---------------------------------------------------------------------------
#pragma package(smart_init)

// иЗМЕНЯЕМ ИМЯ ФАЙЛА ЕСЛИ ОНО ЕСТЬ В ДАННОЙ ДИРЕКТОРИИ. прибавляем (i)
UnicodeString RenameFileName(UnicodeString fileNime)
{
   if(TFile::Exists(fileNime))
   {
			for(int i = 2; ; i++)
			{
				UnicodeString name = ChangeFileExt(fileNime,"") + "(" + i + ")" + ExtractFileExt(fileNime);

				if(!TFile::Exists(name))
				{
				   return name;
                }
			}
   }
   return fileNime;
}

__int64 MyFileSize2(UnicodeString Path)
{
	HANDLE file;
	Path = L"\\\\?\\" + Path;

	file = CreateFileW(Path.w_str(), GENERIC_READ,FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_READONLY, NULL);

	if(file == INVALID_HANDLE_VALUE)
	{
		CloseHandle(file);
		Form3->ErrorLog(Path + "/nОшибка определения размера файла. Ошибка при открытие файла =  "   +   SysErrorMessage(GetLastError())  );
		return -1;
	}
	   //ShowMessage("Non fatal error - File cannot be opened because this file is in use.");

	else
	{
	  __int64 dwSize;
	  dwSize = GetFileSize(file, NULL);
	  CloseHandle(file);

	  if (dwSize == INVALID_FILE_SIZE)
	  {
		 Form3->ErrorLog(Path + "/nОшибка определения размера файла. Ошибка при расчете размера =  "   +   SysErrorMessage(GetLastError())  );
		 // Получим код ошибки.
		 return -2;
	  }
	  else
	  {
		 return dwSize;
	  }

	}
}
