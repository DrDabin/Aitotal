//---------------------------------------------------------------------------
#include <DBXJSON.hpp>

#include <memory>    //std::auto_prt<>
#include <StrUtils.hpp>

#pragma hdrstop

//nclude "jessonLog.h"
#include "Aitotal1.h"

//---------------------------------------------------------------------------
#pragma package(smart_init)


void __fastcall LVItemsToTextINJssonProg()
{
   std::auto_ptr<TStringList>ListJesson(new TStringList(NULL));
   TJSONObject * LisViewGlavn = new TJSONObject();

   LisViewGlavn->AddPair("filenumber", String(Form3->FileNumber));

   TJSONObject *LVItems1;
   TJSONObject *LVItems2;
   TJSONObject *LVItems3;

   TJSONObject *obj;

   TJSONArray *LVArray1 = new TJSONArray();
   TJSONArray *LVArray2 = new TJSONArray();
   TJSONArray *LVArray3 = new TJSONArray();

   __try
   {
	   //Первая таблица
	   for(int I=0; I < Form3->ListView1->Items->Count; I++)
	   {
		  LVItems1 = new TJSONObject();

		  LVItems1->AddPair("namefile",Form3->ListView1->Items->Item[I]->SubItems->Strings[0]);
		  LVItems1->AddPair("filesize",Form3->ListView1->Items->Item[I]->SubItems->Strings[1]);
		  LVItems1->AddPair("md5",Form3->ListView1->Items->Item[I]->SubItems->Strings[2]);
		  LVItems1->AddPair("sha256",Form3->ListView1->Items->Item[I]->SubItems->Strings[3]);

		  if(Form3->ListView1->Items->Item[I]->Data != NULL)
		  {
			  if(((numchek*)Form3->ListView1->Items->Item[I]->Data)->rescan)
				 LVItems1->AddPair("cheked","true");
			  else
				 LVItems1->AddPair("cheked","false");

			  LVItems1->AddPair("filenumber", String(((numchek*)Form3->ListView1->Items->Item[I]->Data)->NumBer));
		  }
		  LVArray1->AddElement(LVItems1);
	   }

	   LisViewGlavn->AddPair("tablica1",LVArray1);
	   //+++

	   // Вторая таблица
	   for(int I=0; I < Form3->ListView2->Items->Count; I++)
	   {
		  LVItems2 = new TJSONObject();

		  LVItems2->AddPair("namefile",Form3->ListView2->Items->Item[I]->SubItems->Strings[0]);
		  LVItems2->AddPair("filesize",Form3->ListView2->Items->Item[I]->SubItems->Strings[1]);
		  LVItems2->AddPair("md5",Form3->ListView2->Items->Item[I]->SubItems->Strings[2]);
		  LVItems2->AddPair("sha256",Form3->ListView2->Items->Item[I]->SubItems->Strings[3]);
		  LVItems2->AddPair("zagproverka",Form3->ListView2->Items->Item[I]->SubItems->Strings[5]);
		  LVItems2->AddPair("urlscan",Form3->ListView2->Items->Item[I]->SubItems->Strings[5]);

		  if( Form3->ListView2->Items->Item[I]->Data != NULL)

			 LVItems2->AddPair("filenumber",String((int)Form3->ListView2->Items->Item[I]->Data));

		  LVArray2->AddElement(LVItems2);
	   }

	   LisViewGlavn->AddPair("tablica2",LVArray2);
	   //+++

	   //Третья таблица
	   for(int I=0; I < Form3->ListView3->Items->Count; I++)
	   {
		   LVItems3 = new TJSONObject();

		 LVItems3->AddPair("namefile",Form3->ListView3->Items->Item[I]->SubItems->Strings[0]);
		 LVItems3->AddPair("rezult",Form3->ListView3->Items->Item[I]->SubItems->Strings[1]);
		 LVItems3->AddPair("filesize",Form3->ListView3->Items->Item[I]->SubItems->Strings[2]);
		 LVItems3->AddPair("md5",Form3->ListView3->Items->Item[I]->SubItems->Strings[3]);
		 LVItems3->AddPair("sha256",Form3->ListView3->Items->Item[I]->SubItems->Strings[4]);
		 LVItems3->AddPair("datascan",Form3->ListView3->Items->Item[I]->SubItems->Strings[5]);
		 LVItems3->AddPair("urlscan",Form3->ListView3->Items->Item[I]->SubItems->Strings[6]);

		 if( Form3->ListView3->Items->Item[I]->Data !=NULL)
		 {
			TJSONObject * ResRescan =(TJSONObject*) TJSONObject::ParseJSONValue(*(String*) Form3->ListView3->Items->Item[I]->Data);

			obj = (TJSONObject*)ResRescan->Get("scans")->JsonValue;
			LVItems3->AddPair("jsonscan", obj);
		 }
		 LVArray3->AddElement(LVItems3);
	   }
	   LisViewGlavn->AddPair("tablica3",LVArray3);
	   //+++
	   ListJesson->Add(LisViewGlavn->ToJSON());

	   if(ListJesson->Text !="")
		  ListJesson->SaveToFile(Form3->PatchProgramma + "AitotalTMP\\jsson.txt");
	   else
		  ShowMessage("Таблицы пустые. Файл сканирования не сохранён.");
   }
   __finally
   {
	   delete LisViewGlavn;
   }

 }
