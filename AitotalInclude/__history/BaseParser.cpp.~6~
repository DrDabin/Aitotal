//---------------------------------------------------------------------------
#include <vcl.h>
#include <memory>    //std::auto_prt<>
#include <System.IOUtils.hpp>
#include <StrUtils.hpp>
#pragma hdrstop

#include "MyInclude/MyStruct.h"
#include "Aitotal1.h"
#include "BaseParser.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
void BaseClass::AddBase(MyBase StructBase)
{
   SpisokBase->Add("<MynameFile>" + StructBase.BaseFileName +"</MynameFile>"+
				   "<MyPathFileName>" + StructBase.BasePatchFileName + "</MyPathFileName>"+
				   "<MyMD5>" + StructBase.BaseMD5 + "</MyMD5>"+
				   "<MySHA256>" + StructBase.BaseSHA256 + "</MySHA256>" +
				   "<MySizeFile>" + StructBase.BaseSizeFile + "</MySizeFile>" +
				   "<MyDate>" + StructBase.BaseDataProverki +"</MyDate>" +
				   "<MyDetect>" + StructBase.BaseDetect + "</MyDetect>" +
				   "<MyAdress>" + StructBase.BaseAdress +"</MyAdress>" +
				   "<MyPatchFileArchiv>"+StructBase.BasePatchFileArchiv+"<MyPatchFileAchiv>"+
				   "<MYJesson>" + StructBase.BaseJesson+ "</MyJesson>"
   );
}
void BaseClass::SaveToLog(UnicodeString StrokaSave)
{
   //TDirectory::Exists
   if(TFile::Exists(StrokaSave))
   {
	   std::auto_ptr<TStringList>FileSpisokBase(new TStringList(NULL));
	   FileSpisokBase->LoadFromFile(StrokaSave);
	   FileSpisokBase->Add(SpisokBase->Text.Trim());
	   SpisokBase->Text = FileSpisokBase->Text;
	   SpisokBase->SaveToFile(StrokaSave);
   }
   else
	  SpisokBase->SaveToFile(StrokaSave);
}
BaseClass::BaseClass()
{
   SpisokBase =	new TStringList(NULL);
   PosiciyaPoisk = 0;
}

BaseClass::~BaseClass()
{
	SpisokBase->Clear();
	delete SpisokBase;
}
//ƒобавл€ю и сразже сохран€ю.
void BaseClass::AddSaveTolog(MyBase StructBase, UnicodeString StrokaSave)
{
   AddBase(StructBase);
   SaveToLog(StrokaSave);
}
UnicodeString BaseClass::TexTega(UnicodeString text, UnicodeString beginTeg, UnicodeString endTeg,__int64 Posiciya)
{
	int begin = PosEx(beginTeg,text,Posiciya);
	if (begin == 0)
		return "";
	else
	   begin+= beginTeg.Length();

	int end = PosEx(endTeg,text,begin);
	if(end==0)
	   return "";
	PosiciyaPoisk = end + endTeg.Length();
	return text.SubString(begin, end - begin);
}

MyBase BaseClass::LogToMyStruct(UnicodeString StrokaSave)
{
  MyBase Base;

  Base.BaseFileName = TexTega(StrokaSave,"<MynameFile>","</MynameFile>",0);
  Base.BasePatchFileName = TexTega(StrokaSave,"<MyPathFileName>","</MyPathFileName>",0);
  Base.BaseMD5 = TexTega(StrokaSave,"<MyMD5>","</MyMD5>",0);
  Base.BaseSHA256 = TexTega(StrokaSave,"<MySHA256>","</MySHA256>",0);
  Base.BaseSizeFile = TexTega(StrokaSave,"<MySizeFile>","</MySizeFile>",0).ToInt();
  Base.BaseDataProverki = TexTega(StrokaSave,"MyDate","</MyDate",0);
  Base.BaseDetect = TexTega(StrokaSave,"<MyDetect>","</MyDetect>",0);
  Base.BaseAdress = TexTega(StrokaSave,"<MyAdress>","</MyAdress>",0);
  Base.BasePatchFileArchiv = TexTega(StrokaSave,"<MyPatchFileArchiv>","</MyPatchFileArchiv>",0);
  Base.BaseJesson = TexTega(StrokaSave,"<MYJesson>","</MYJesson>",0);

  return Base;
}

void BaseClass::AddToListItem()
{
   if(TFile::Exists(StrokaSave))
   {
	  std::auto_ptr<TStringList>FileSpisokBase(new TStringList(NULL));

	  FileSpisokBase->LoadFromFile(StrokaSave);

	  if(FileSpisokBase->Text !="")
	  {
		 TListItem *ListItem;

		 for( int i =0; i < FileSpisokBase->Count ; i++)
		 {
			 if(FileSpisokBase->Strings[i] !="")
			 {
				MyBase Base = LogToMyStruct(FileSpisokBase->Strings[i]);

				ListItem = Form3->ListView3->Items->Add();
				ListItem->Checked = false;
				ListItem->Caption = Base.BaseFileName; // »м€ файла
				ListItem->SubItems->Add(Base.BasePatchFileName);// пулный путь.
				ListItem->SubItems->Add(Base.BaseMD5);// хеш сумма
				ListItem->SubItems->Add(Base.BaseSHA256);
				ListItem->SubItems->Add(Base.BaseSizeFile);// размер
				ListItem->SubItems->Add(Base.BaseDataProverki);
				ListItem->SubItems->Add(Base.BaseDetect);// результат сканировани€
				ListItem->SubItems->Add(Base.BaseAdress);// ссылка на результат.
			 }
		 }
	  }
   }
}
